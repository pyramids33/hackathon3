<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>login required</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap-reboot.min.css">
</head>
<body>
<h2>login required</h2>
<div id="moneybutton"></div>


<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src='https://www.moneybutton.com/moneybutton.js'></script>
<script>
$(function () {

    $.get({
        url: 'http://localhost:6767/getToken',
        success: function(data, data2){
            console.log('got token', data);
            showLogin(data.token);
        },
        error: function (err) {
            console.log(err);
        }
    });

    function showLogin (token) {
        var $mb = $('#moneybutton');

        moneyButton.render($mb[0], {
            type: 'buy',
            label: 'swipe to login',
            cryptoOperations: [
                {
                    name: 'myAddress',
                    method: 'address'
                },
                {
                    name: 'mySignature',
                    method: 'sign',
                    data: token,
                    dataEncoding: 'utf8',
                    key: 'identity',
                    algorithm: 'bitcoin-signed-message'
                }
            ],
            onCryptoOperations: function (cryptoOperations) {
                console.log(cryptoOperations);
                doLogin(cryptoOperations[1].data, cryptoOperations[1].value, cryptoOperations[0].value, cryptoOperations[0].paymail);
            },
            onError: function (arg) { 
                console.log(arg);
            }
        });
    }


    function doLogin (token, sig, address, paymail) {
        $.ajax({
            url: 'http://localhost:6767/doLogin',
            method: 'POST',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({
                token: token,
                sig: sig,
                address: address,
                paymail: paymail
            }),
            success: function(data){
                if (data && data.error) {
                    $('#moneybutton').text('Login Failed: ' + data.error);
                } else {
                    location.reload(true);
                }
            },
            error: function (err) {
                $('#moneybutton').text('Login Failed: ' + error.toString());
            }
        });
    }

});
</script>

</body>
</html>